<!doctype html>
<html lang="pl" data-mode="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ustawienia – Notatnik ciśnienia i analiza</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="./styles.css" />
</head>

<body>
  <header class="appHeader">
    <div class="wrap headerRow">
      <div class="brand">
        <div class="brandIcon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M20 12h-3l-2 5-4-12-2 7H4" stroke="currentColor" stroke-width="2" stroke-linecap="round"
              stroke-linejoin="round" />
            <path d="M12 21s-7-4.5-9-9a5.5 5.5 0 0 1 9-5 5.5 5.5 0 0 1 9 5c-2 4.5-9 9-9 9Z" stroke="currentColor"
              stroke-width="2" stroke-linejoin="round" />
          </svg>
        </div>
        <div>
          <h1>Ustawienia</h1>
          <div class="sub">Wygląd, leki, import/export.</div>
        </div>
      </div>

      <div class="toolbar">
        <a class="linkBtn" href="./index.html" title="Wróć">Wróć</a>
      </div>
    </div>
  </header>

  <main class="grid single">
    <section class="card">
      <div class="cardHead">
        <h2>Ustawienia</h2>
      </div>

      <div class="cardBodyScroll">
        <h2 class="sectionTitle">Wygląd</h2>

        <div class="block">
          <div>
            <label for="themeSelect">Motyw</label>
            <select id="themeSelect"></select>
          </div>

          <div class="modeRow">
            <div>
              <div class="modeTitle">Tryb ciemny</div>
              <div class="small">Zmienia tło i kontrast.</div>
            </div>

            <label class="switch" aria-label="Tryb ciemny">
              <input type="checkbox" id="modeToggle" />
              <span class="slider"></span>
            </label>
          </div>
        </div>

        <div class="hr"></div>

        <h2 class="sectionTitle">Leki</h2>

        <div class="small" style="margin-bottom:10px;">
          Dodaj leki, które chcesz kontrolować.
        </div>

        <div class="row">
          <div>
            <label for="medName">Nazwa</label>
            <input id="medName" placeholder="np. Atacand" />
          </div>
          <div>
            <label for="medDose">Dawka</label>
            <input id="medDose" placeholder="np. 4 mg" />
          </div>
        </div>

        <div class="row mt10">
          <div class="rowInline">
            <div>
              <label for="medTime">Domyślna godzina</label>
              <input id="medTime" type="time" value="07:30" />
            </div>
            <div class="toggleField">
              <div class="toggleLabel">Dora&#x17A;ne</div>
              <label class="switch" aria-label="Dora&#x17A;ne">
                <input type="checkbox" id="medPrn" />
                <span class="slider"></span>
              </label>
            </div>
          </div>
          <div style="display:grid; align-content:end; gap:8px;">
            <button id="addMedBtn" type="button" class="ok">Dodaj lek</button>
            <button id="cancelMedBtn" type="button" class="secondary hidden">Anuluj</button>
          </div>
        </div>

        <div class="mt10" id="medList"></div>

        <div class="hr"></div>

        <div class="hr"></div>

        <h2 class="sectionTitle">Udostępnianie (Beta)</h2>
        <div class="block">
          <div class="small" style="margin-bottom:10px;">
            Twoje dane są domyślnie prywatne. Tutaj możesz dać innym podgląd (tylko odczyt).
          </div>
          <div class="row" style="display:flex; gap:8px;">
            <input id="shareEmail" placeholder="Wpisz email innej osoby..." style="flex:1;" />
            <button id="shareBtn" type="button" class="ok">Dodaj</button>
          </div>
          <div class="mt10" id="shareList"></div>

          <div class="hr"></div>

          <div class="small" style="margin-bottom:5px;">
            Dane udostępnione DLA Ciebie (kliknij, aby otworzyć podgląd):
          </div>
          <div class="mt10" id="sharedWithMeList"></div>
        </div>

        <div class="hr"></div>

        <h2 class="sectionTitle">Dane</h2>


        <div class="small" style="margin-bottom:10px;">
          Export i import działają na JSONie całej bazy w localStorage.
        </div>

        <div class="btns">
          <button id="exportAllBtn" type="button">Export JSON</button>
          <button id="importBtn" type="button" class="secondary">Import JSON</button>
          <button id="exportMedsBtn" type="button">Export leków</button>
          <button id="importMedsBtn" type="button" class="secondary">Import leków</button>
          <button id="wipeBtn" type="button" class="danger">Wyczyść wszystko</button>
          <input id="importFile" type="file" accept="application/json" class="hidden" />
          <input id="importMedsFile" type="file" accept="application/json" class="hidden" />
        </div>

        <div class="hr"></div>

        <div class="btns">
          <button id="resetSettingsBtn" class="secondary" type="button">Reset ustawień</button>
        </div>

        <div class="small" style="margin-top:10px;">
          Dane są trzymane lokalnie w przeglądarce (localStorage).
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <script src="./themes.js"></script>
  <script>
    (() => {
      window.Theme.initThemeUI();

      const MEDS_KEY = "bp_chatlog_meds_v1";
      const STORAGE_KEY = "bp_chatlog_items_v4";

      function toast(msg) {
        const t = document.getElementById("toast");
        t.textContent = msg;
        t.classList.remove("hidden");
        clearTimeout(toast._tm);
        toast._tm = setTimeout(() => t.classList.add("hidden"), 2200);
      }

      function slugify(s) {
        return String(s || "")
          .toLowerCase()
          .trim()
          .replace(/\s+/g, "-")
          .replace(/[^a-z0-9\-]/g, "");
      }

      function escapeAttr(s) {
        return String(s || "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;");
      }

      function loadMeds() {
        try {
          const raw = localStorage.getItem(MEDS_KEY);
          const arr = raw ? JSON.parse(raw) : [];
          return Array.isArray(arr) ? arr : [];
        } catch {
          return [];
        }
      }

      async function saveMeds(meds) {
        localStorage.setItem(MEDS_KEY, JSON.stringify(meds));
        try {
          const rawItems = localStorage.getItem(STORAGE_KEY);
          const items = rawItems ? JSON.parse(rawItems) : [];
          await fetch("/api/bp/sync", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ items, meds })
          });
        } catch (e) { console.error("Sync failed", e); }
      }

      function renderMeds() {
        const box = document.getElementById("medList");
        const meds = loadMeds();

        if (!meds.length) {
          box.innerHTML = `<div class="small">Brak leków na liście.</div>`;
          return;
        }

        box.innerHTML = "";
        meds.forEach((m) => {
          const safeName = escapeAttr(m.name || "-");
          const safeDose = escapeAttr(m.dose || "");
          const safeTime = escapeAttr(m.defaultTime || "");
          const prnLabel = m.prn ? "dora\u017anie" : "";
          const tooltip = [m.name, m.dose, prnLabel || m.defaultTime].filter(Boolean).join(" | ");
          const safeTooltip = escapeAttr(tooltip || m.name || "");
          const row = document.createElement("div");
          row.className = "medItem";

          const left = document.createElement("div");
          left.className = "left";
          left.innerHTML = `
            <div class="name tooltipTrigger" data-tooltip="${safeTooltip}"><span class="medNameText">${safeName}</span></div>
            <div class="hint">${safeDose}${prnLabel ? " | " + prnLabel : (safeTime ? " | " + safeTime : "")} | ${m.active ? "active" : "inactive"}</div>
          `;

          const right = document.createElement("div");
          right.className = "right";

          const edit = document.createElement("button");
          edit.type = "button";
          edit.className = "secondary";
          edit.textContent = "Edytuj";
          edit.onclick = () => {
            const meds2 = loadMeds();
            const idx = meds2.findIndex(x => x.id === m.id);
            if (idx < 0) return;
            const med = meds2[idx];
            editingId = med.id;
            document.getElementById("medName").value = med.name || "";
            document.getElementById("medDose").value = med.dose || "";
            if (medTimeInput) medTimeInput.dataset.lastTime = med.defaultTime || "";
            if (medTimeInput) medTimeInput.value = med.defaultTime || "";
            if (medPrnToggle) medPrnToggle.checked = Boolean(med.prn);
            syncMedTimeState();
            if (addMedBtn) addMedBtn.textContent = "Zapisz zmiany";
            if (cancelMedBtn) cancelMedBtn.classList.remove("hidden");
          };

          const toggle = document.createElement("button");
          toggle.type = "button";
          toggle.className = "secondary";
          toggle.textContent = m.active ? "Dezaktywuj" : "Aktywuj";
          toggle.onclick = () => {
            const meds2 = loadMeds();
            const idx = meds2.findIndex(x => x.id === m.id);
            if (idx >= 0) {
              meds2[idx].active = !meds2[idx].active;
              saveMeds(meds2);
              renderMeds();
              toast("Zapisano.");
            }
          };

          const del = document.createElement("button");
          del.type = "button";
          del.className = "danger";
          del.textContent = "Usuń";
          del.onclick = () => {
            const ok = confirm(`Usunąć lek "${m.name}"?`);
            if (!ok) return;
            const meds2 = loadMeds().filter(x => x.id !== m.id);
            saveMeds(meds2);
            renderMeds();
            toast("Usunięto.");
          };

          right.appendChild(edit);
          right.appendChild(toggle);
          right.appendChild(del);

          row.appendChild(left);
          row.appendChild(right);
          box.appendChild(row);
        });
      }

      const medTimeInput = document.getElementById("medTime");
      const medPrnToggle = document.getElementById("medPrn");
      const addMedBtn = document.getElementById("addMedBtn");
      const cancelMedBtn = document.getElementById("cancelMedBtn");
      let editingId = null;

      function syncMedTimeState() {
        if (!medTimeInput || !medPrnToggle) return;
        if (medPrnToggle.checked) {
          if (!medTimeInput.dataset.lastTime) medTimeInput.dataset.lastTime = medTimeInput.value || "";
          medTimeInput.value = "";
          medTimeInput.disabled = true;
        } else {
          medTimeInput.disabled = false;
          if (!medTimeInput.value) medTimeInput.value = medTimeInput.dataset.lastTime || "07:30";
        }
      }

      if (medPrnToggle) medPrnToggle.addEventListener("change", syncMedTimeState);
      syncMedTimeState();

      function resetMedForm() {
        editingId = null;
        document.getElementById("medName").value = "";
        document.getElementById("medDose").value = "";
        if (medPrnToggle) medPrnToggle.checked = false;
        if (medTimeInput) medTimeInput.value = medTimeInput.dataset.lastTime || "07:30";
        syncMedTimeState();
        if (addMedBtn) addMedBtn.textContent = "Dodaj lek";
        if (cancelMedBtn) cancelMedBtn.classList.add("hidden");
      }

      if (cancelMedBtn) {
        cancelMedBtn.addEventListener("click", resetMedForm);
      }

      addMedBtn.addEventListener("click", () => {
        const name = document.getElementById("medName").value.trim();
        const dose = document.getElementById("medDose").value.trim();
        const isPrn = Boolean(medPrnToggle?.checked);
        const defaultTime = isPrn ? "" : (medTimeInput?.value || "");

        if (!name) return alert("Podaj nazw? leku.");

        const meds = loadMeds();

        if (editingId) {
          const idx = meds.findIndex(x => x.id === editingId);
          if (idx >= 0) {
            meds[idx] = { ...meds[idx], name, dose, defaultTime, prn: isPrn };
            saveMeds(meds);
            renderMeds();
            resetMedForm();
            toast("Zapisano zmiany.");
            return;
          } else {
            editingId = null;
          }
        }

        const id = slugify(name + "-" + dose);
        if (meds.some(m => m.id === id)) return alert("Taki lek (o tej nazwie i dawce) już istnieje.");

        meds.push({ id, name, dose, defaultTime, prn: isPrn, active: true });
        saveMeds(meds);

        resetMedForm();
        renderMeds();
        toast("Dodano lek.");
      });

      document.getElementById("exportAllBtn").addEventListener("click", () => {
        const raw = localStorage.getItem(STORAGE_KEY);
        const items = raw ? JSON.parse(raw) : [];
        const payload = {
          exportedAt: new Date().toISOString(),
          app: "bp-chatlog",
          version: 4,
          scope: "all",
          items
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `notatnik-export-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        toast("Wyeksportowano.");
      });

      document.getElementById("importBtn").addEventListener("click", () => {
        document.getElementById("importFile").click();
      });

      document.getElementById("exportMedsBtn").addEventListener("click", () => {
        const meds = loadMeds();
        const payload = {
          exportedAt: new Date().toISOString(),
          app: "bp-chatlog",
          version: 1,
          scope: "meds",
          meds
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `notatnik-leki-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
        URL.revokeObjectURL(url);
        toast("Wyeksportowano leki.");
      });

      document.getElementById("importMedsBtn").addEventListener("click", () => {
        document.getElementById("importMedsFile").click();
      });

      document.getElementById("importFile").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        try {
          const txt = await f.text();
          const json = JSON.parse(txt);
          const items = Array.isArray(json?.items) ? json.items : null;
          if (!items) return alert("Zły format. Oczekuję JSON z polem items[].");

          const ok = confirm(`Zaimportować wpisy: ${items.length}? Nadpisze to obecną bazę.`);
          if (!ok) return;

          localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
          toast("Zaimportowano.");
        } catch (err) {
          alert("Import nie wyszedł. JSON jest uszkodzony albo w złym formacie.");
        } finally {
          e.target.value = "";
        }
      });

      document.getElementById("importMedsFile").addEventListener("change", async (e) => {
        const f = e.target.files?.[0];
        if (!f) return;
        try {
          const txt = await f.text();
          const json = JSON.parse(txt);
          const meds = Array.isArray(json?.meds) ? json.meds : null;
          if (!meds) return alert("Zły format. Oczekuję JSON z polem meds[].");

          const ok = confirm(`Zaimportować leki: ${meds.length}? Nadpisze to obecną listę.`);
          if (!ok) return;

          saveMeds(meds);
          renderMeds();
          toast("Zaimportowano leki.");
        } catch (err) {
          alert("Import leków nie wyszedł. JSON jest uszkodzony albo w złym formacie.");
        } finally {
          e.target.value = "";
        }
      });

      document.getElementById("wipeBtn").addEventListener("click", () => {
        const ok = confirm("Wyczyścić WSZYSTKIE wpisy? Tego nie cofniesz.");
        if (!ok) return;
        localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
        toast("Wyczyszczono.");
      });

      document.getElementById("resetSettingsBtn").addEventListener("click", () => {
        const ok = confirm("Zresetować ustawienia motywu do domyślnych? (Lista leków zostaje)");
        if (!ok) return;

        const def = window.Theme.getDefaultSettings();
        window.Theme.saveSettings(def);
        window.Theme.applyTheme(def);

        document.getElementById("themeSelect").value = def.themeId;
        document.getElementById("modeToggle").checked = def.mode === "dark";

        toast("Zresetowano ustawienia.");
      });

      renderMeds();

      /* Sync Logic */
      async function syncMeds() {
        try {
          const res = await fetch("/api/bp/sync");
          const json = await res.json();
          if (json.ok) {
            const serverEmail = json.email;
            const localOwner = localStorage.getItem("bp_owner_email");
            const serverMeds = json.meds || [];

            // 1. Owner Mismatch Check
            if (serverEmail && localOwner && localOwner !== serverEmail) {
              // Wiping happen in app.js mainly, but here we can just accept Server Data
              localStorage.setItem(MEDS_KEY, JSON.stringify(serverMeds));
              renderMeds();
              return;
            }
            if (!localOwner && serverEmail) {
              if (serverMeds.length > 0) {
                localStorage.setItem(MEDS_KEY, JSON.stringify(serverMeds));
                renderMeds();
              }
              localStorage.setItem("bp_owner_email", serverEmail);
            }

            const localMeds = loadMeds();
            let finalMeds = localMeds;
            let dirty = false;

            // Simple Merge: Server wins if it has content and local is smaller/empty.
            if (serverMeds.length > localMeds.length) {
              finalMeds = serverMeds;
              localStorage.setItem(MEDS_KEY, JSON.stringify(finalMeds));
              renderMeds();
              toast("Leki zaktualizowane z chmury.");
            } else if (localMeds.length > serverMeds.length) {
              dirty = true;
            }

            if (dirty || localMeds.length > 0) {
              const rawItems = localStorage.getItem(STORAGE_KEY);
              const items = rawItems ? JSON.parse(rawItems) : [];
              await fetch("/api/bp/sync", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ items, meds: finalMeds })
              });
            }
          }
        } catch (e) { console.error(e); }
      }
      syncMeds();

      /* Sharing Logic */
      async function fetchSharing() {
        try {
          const res1 = await fetch("/api/bp/share");
          const json1 = await res1.json();
          const shareList = document.getElementById("shareList");
          if (json1.ok && shareList) {
            shareList.innerHTML = "";
            json1.sharedTo.forEach(email => {
              const row = document.createElement("div");
              row.style.marginBottom = "4px";
              row.style.display = "flex";
              row.style.alignItems = "center";
              row.style.gap = "8px";
              row.innerHTML = `<div style="flex:1">${escapeAttr(email)}</div>`;
              const btn = document.createElement("button");
              btn.className = "danger";
              btn.style.padding = "4px 8px";
              btn.style.fontSize = "12px";
              btn.textContent = "Usuń";
              btn.onclick = async () => {
                if (!confirm("Zabrać dostęp?")) return;
                await fetch("/api/bp/share", {
                  method: "DELETE",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ targetEmail: email })
                });
                fetchSharing();
                toast("Usunięto dostęp.");
              };
              row.appendChild(btn);
              shareList.appendChild(row);
            });
          }

          const res2 = await fetch("/api/bp/shared-with-me");
          const json2 = await res2.json();
          const swmList = document.getElementById("sharedWithMeList");
          if (json2.ok && swmList) {
            swmList.innerHTML = "";
            json2.owners.forEach(email => {
              const row = document.createElement("div");
              row.style.marginBottom = "4px";
              const link = document.createElement("a");
              link.href = `/bp-chatlog/index.html?viewUser=${encodeURIComponent(email)}`;
              link.textContent = email;
              link.className = "linkBtn";
              link.style.display = "block";
              link.style.background = "var(--bg-card)";
              link.style.border = "1px solid var(--border)";
              link.style.padding = "6px";
              link.style.textAlign = "center";
              row.appendChild(link);
              swmList.appendChild(row);
            });
          }
        } catch (e) { console.error(e); }
      }

      if (document.getElementById("shareBtn")) {
        fetchSharing();
        document.getElementById("shareBtn").addEventListener("click", async () => {
          const email = document.getElementById("shareEmail").value.trim();
          if (!email) return alert("Podaj email.");
          try {
            const res = await fetch("/api/bp/share", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ targetEmail: email })
            });
            const json = await res.json();
            if (json.ok) {
              document.getElementById("shareEmail").value = "";
              fetchSharing();
              toast("Udostępniono.");
            } else {
              alert("Błąd: " + (json.error || "Nieznany"));
            }
          } catch (e) { alert("Błąd sieci."); }
        });
      }
    })();
  </script>
</body>

</html>